<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Robot Comparison</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;font-family:system-ui,sans-serif}
    body{overflow-x:auto;overflow-y:hidden;background:#f3f4f6}
    #app{min-width:fit-content;height:100%;display:flex;flex-direction:column;background:#f3f4f6}
    .grid-row{display:grid;grid-template-columns:180px repeat(var(--cols),minmax(100px,300px));min-width:fit-content}
    .cell{display:flex;align-items:center;justify-content:center;padding:6px;border-bottom:1px solid #e5e7eb;min-height:32px;font-size:13px;background:#fff;white-space:nowrap}
    .cell-label{background:#1f2937;color:#fff;justify-content:flex-start;padding-left:12px;font-weight:500;font-size:12px;border-bottom:1px solid #374151;position:relative;padding-right:60px}
    .cell-label-click{cursor:pointer}.cell-label-click:hover{background:#374151}
    .tag-best{background:#fee2e2;color:#dc2626;padding:2px 8px;border-radius:4px;font-weight:600}
    .tag-worst{background:#dcfce7;color:#16a34a;padding:2px 8px;border-radius:4px}
    .unit{color:#9ca3af;font-size:11px;margin-left:2px}
    .cell-ksp{background:#fefce8;color:#713f12;font-size:11px;line-height:1.3;padding:6px 8px;text-align:left;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%}
    .cell-ksp:hover{overflow-x:auto;text-overflow:clip}
    .cell-ksp::-webkit-scrollbar{height:4px;background:#fef3c7}
    .cell-ksp::-webkit-scrollbar-thumb{background:#f59e0b;border-radius:2px}
    .cell-ksp:hover{overflow-x:auto;cursor:text}
    .cell-ksp::-webkit-scrollbar{height:4px}
    .cell-ksp::-webkit-scrollbar-thumb{background:#d97706;border-radius:2px}
    .cell-ksp:hover{overflow:visible;white-space:normal;z-index:10;position:relative;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .cell-ksp-label{background:#eab308;color:#fff;font-weight:600;font-size:11px;justify-content:flex-start;padding-left:12px;border-bottom:1px solid #ca8a04}
    .cell-ksp-section{background:#f59e0b;color:#fff;font-size:10px;text-transform:uppercase;letter-spacing:.5px;font-weight:600;cursor:pointer;padding:6px 12px;justify-content:space-between}
    .cell-ksp-section:hover{background:#d97706}.cell-ksp-section-empty{background:#fef3c7;padding:6px}
    .cell-section{background:#374151;color:#9ca3af;font-size:10px;text-transform:uppercase;letter-spacing:.5px;font-weight:600;cursor:pointer;padding:6px 12px;justify-content:space-between;position:relative;padding-right:100px}
    .cell-section:hover{background:#4b5563}.cell-section-empty{background:#f3f4f6;padding:6px}
    .simple-select{border:none;background:transparent;font-size:12px;text-align:center;text-align-last:center;cursor:pointer;padding:4px 2px;color:#374151;width:100%}.simple-select:focus{outline:none}
    .simple-select option{text-align:center}
    .brand-select{font-weight:600;color:#1e40af;font-size:13px;text-align:center;text-align-last:center}
    .brand-select option{text-align:center}
    .cat-select{border:none;background:transparent;font-size:14px;font-weight:600;color:#fff;cursor:pointer;width:100%;text-align:center;padding:8px;height:100%}.cat-select option{color:#1f2937}
    .collapse-icon{transition:transform .2s;font-size:10px}.collapse-icon.collapsed{transform:rotate(-90deg)}
    .img-cell{padding:0;background:linear-gradient(135deg,#f3f4f6,#e5e7eb);position:relative;overflow:hidden;aspect-ratio:1/1;border-bottom:1px solid #e5e7eb}
    .img-cell img { max-height:90px; max-width:120px; object-fit:contain; }{width:100%;height:100%;object-fit:cover;object-position:top center}
    .cell.bg-gray-800{display:flex;align-items:stretch;justify-content:center;padding:0;border-bottom:1px solid #374151}
    .scroll-area{background:#f3f4f6;overflow-y:auto;flex:1}
    .footer{background:#f3f4f6;padding:24px;text-align:center;color:#9ca3af;font-size:12px;font-weight:300}
    .loading{display:flex;align-items:center;justify-content:center;height:100%;color:#6b7280;flex-direction:column;gap:16px}
    .spinner{width:48px;height:48px;border:4px solid #e5e7eb;border-top-color:#3b82f6;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .action-btn{position:absolute;top:50%;transform:translateY(-50%);background:#4b5563;color:#fff;border:none;padding:2px 8px;border-radius:3px;font-size:9px;cursor:pointer;opacity:0;transition:opacity .2s}
    .cell-section:hover .action-btn,.cell-label:hover .action-btn{opacity:1}
    .action-btn:hover{background:#6b7280}
    .action-btn.edit{right:68px}
    .action-btn.delete{right:36px;background:#dc2626}
    .action-btn.delete:hover{background:#b91c1c}
    .drag-handle{position:absolute;right:4px;top:50%;transform:translateY(-50%);cursor:grab;color:#9ca3af;font-size:10px;opacity:0;transition:opacity .2s}
    .cell-section:hover .drag-handle,.cell-label:hover .drag-handle{opacity:1}
    .drag-handle:active{cursor:grabbing}
    .add-btn{background:transparent;color:#9ca3af;border:none;cursor:pointer;font-size:20px;padding:8px;padding-left:12px;transition:all .2s;display:flex;align-items:center;justify-content:flex-start;min-height:40px}
    .add-btn:hover{background:#e5e7eb;color:#374151;font-size:24px}
    .add-btn.locked{color:#9ca3af;font-size:14px}
    .add-btn.locked:hover{background:#f3f4f6;color:#6b7280;font-size:16px}
    .add-row{border-bottom:none}
    .edit-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000}
    .edit-panel{background:#fff;border-radius:8px;padding:24px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto}
    .edit-input{border:1px solid #d1d5db;padding:8px;border-radius:4px;width:100%;font-size:14px;margin-top:4px}
    .edit-input:focus{outline:none;border-color:#3b82f6}
    .radio-group{display:flex;gap:16px;margin-top:8px}
    .radio-label{display:flex;align-items:center;gap:6px;cursor:pointer;padding:8px 12px;border:1px solid #d1d5db;border-radius:4px;transition:all .2s}
    .radio-label:has(input:checked){background:#eff6ff;border-color:#3b82f6}
    .radio-label input{cursor:pointer}
    .grid-row.dragging{opacity:0.3}
    .grid-row.drag-over{border-top:3px solid #3b82f6}
    .new-prop-hint{background:#fef3c7;padding:8px 12px;border-left:3px solid #f59e0b;margin-bottom:12px;font-size:12px;color:#92400e}
    .col-control{display:flex;align-items:center;gap:8px;background:#374151;padding:4px 8px;border-radius:6px}
    .col-btn{background:#4b5563;color:#fff;border:none;width:28px;height:28px;border-radius:4px;cursor:pointer;font-size:16px;font-weight:bold;display:flex;align-items:center;justify-content:center;transition:background .2s}
    .col-btn:hover{background:#6b7280}
    .col-btn:disabled{background:#374151;color:#6b7280;cursor:not-allowed}
    .col-count{color:#fff;font-weight:600;min-width:60px;text-align:center;font-size:13px}
    .login-panel{background:#fff;border-radius:12px;padding:32px;width:90%;max-width:400px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
    .login-title{font-size:24px;font-weight:700;color:#1f2937;margin-bottom:8px;text-align:center}
    .login-subtitle{font-size:13px;color:#6b7280;margin-bottom:24px;text-align:center}
    .login-input{border:1px solid #d1d5db;padding:12px;border-radius:6px;width:100%;font-size:14px;margin-top:6px;transition:border .2s}
    .login-input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}
    .login-label{display:block;margin-bottom:16px;font-size:13px;font-weight:600;color:#374151}
    .login-btn{background:#3b82f6;color:#fff;border:none;padding:12px;border-radius:6px;width:100%;font-size:14px;font-weight:600;cursor:pointer;transition:background .2s;margin-top:8px}
    .login-btn:hover{background:#2563eb}
    .login-error{background:#fee2e2;color:#dc2626;padding:10px;border-radius:6px;font-size:13px;margin-bottom:16px;display:none}
    .logout-btn{background:#dc2626;color:#fff;border:none;padding:4px 12px;border-radius:4px;font-size:12px;cursor:pointer;transition:background .2s}
    .logout-btn:hover{background:#b91c1c}
    .user-info{display:flex;align-items:center;gap:8px;background:#374151;padding:4px 12px;border-radius:6px;color:#fff;font-size:13px}
    .lock-icon{width:16px;height:16px;fill:currentColor}
  </style>
</head>
<body class="bg-gray-100">
<div id="app" class="h-full flex flex-col"><div class="loading"><div class="spinner"></div><span>Loading data...</span></div></div>
<script>
const API='/api',U={'Height':'m','Weight':'kg','Length':'m','Total DOF':'DOF','Navigation Max':'m/s','Max Speed':'m/s','Payload':'kg','Runtime':'h','Battery':'Wh','Charge Time':'h','Computing':'TOPS','Diameter':'cm','Suction Power':'Pa','Flight Time':'min','Max Range':'km','Reach':'mm','Repeatability':'mm'};
let C=[],R=[],cur='',SG=[],sB=[],sM=[],col={},kspCol=0,swap={},dragSpec=null,dragGroup=null,allProps=[],defaultSG=[],numCols=4,isLoggedIn=false,hasKSP=false;
const ADMIN_USER='Kimi.Zhou',ADMIN_PASS='Anker2025';
const lockSvg='<svg class="lock-icon" viewBox="0 0 24 24"><path d="M12 2C9.243 2 7 4.243 7 7v2H6c-1.103 0-2 .897-2 2v9c0 1.103.897 2 2 2h12c1.103 0 2-.897 2-2v-9c0-1.103-.897-2-2-2h-1V7c0-2.757-2.243-5-5-5zM9 7c0-1.654 1.346-3 3-3s3 1.346 3 3v2H9V7zm9 4v9H6v-9h12z"/><path d="M13 16.586V18h-2v-1.414c-.608-.346-1-.992-1-1.586 0-1.103.897-2 2-2s2 .897 2 2c0 .594-.392 1.24-1 1.586z"/></svg>';
const checkAuth=()=>{const saved=localStorage.getItem('admin_auth');if(saved){const{user,pass,time}=JSON.parse(saved);if(user===ADMIN_USER&&pass===ADMIN_PASS&&Date.now()-time<86400000){isLoggedIn=true;return true}}isLoggedIn=false;return false};
const saveAuth=()=>{localStorage.setItem('admin_auth',JSON.stringify({user:ADMIN_USER,pass:ADMIN_PASS,time:Date.now()}))};
const clearAuth=()=>{localStorage.removeItem('admin_auth');isLoggedIn=false};
const showLoginModal=()=>{const modal=document.createElement('div');modal.className='edit-modal';modal.innerHTML=`<div class="login-panel"><h2 class="login-title">üîê Admin Login</h2><p class="login-subtitle">Please enter your credentials to edit</p><div class="login-error" id="login-error">Invalid username or password</div><label class="login-label">Username<input type="text" class="login-input" id="login-user" placeholder="Enter username"></label><label class="login-label">Password<input type="password" class="login-input" id="login-pass" placeholder="Enter password"></label><button class="login-btn" onclick="doLogin()">Login</button><button onclick="this.closest('.edit-modal').remove()" style="background:#e5e7eb;color:#374151;border:none;padding:12px;border-radius:6px;width:100%;font-size:14px;cursor:pointer;margin-top:8px">Cancel</button></div>`;document.body.appendChild(modal);document.getElementById('login-user').focus()};
const doLogin=()=>{const user=document.getElementById('login-user').value;const pass=document.getElementById('login-pass').value;if(user===ADMIN_USER&&pass===ADMIN_PASS){isLoggedIn=true;saveAuth();document.querySelector('.edit-modal').remove();render()}else{document.getElementById('login-error').style.display='block'}};
const doLogout=()=>{if(confirm('Logout from admin?')){clearAuth();render()}};
const gB=()=>[...new Set(R.map(r=>r.company))];
const gM=b=>R.filter(r=>r.company===b);
const init=()=>{const B=gB();sB=[];sM=[];for(let i=0;i<Math.min(numCols,R.length);i++){sB.push(R[i].company);sM.push(R[i].id)}while(sB.length<numCols){sB.push('');sM.push(null)}col={};kspCol=0;swap={}};const bw=(s,k,b)=>{const v=s.map(r=>r?.specs[k]).filter(x=>typeof x==='number');if(v.length<2||!b)return{best:null,worst:null};const mx=Math.max(...v),mn=Math.min(...v);if(mx===mn)return{best:null,worst:null};const ab=swap[k]?(b==='max'?'min':'max'):b;return ab==='max'?{best:mx,worst:mn}:{best:mn,worst:mx}};
const fv=(k,v)=>{if(v==null||v==='')return'‚Äì';if(typeof v!=='number')return v;const u=U[k];return u?`${v}<span class="unit">${u}</span>`:v};
const ft=(k,v,c)=>{if(typeof v!=='number')return`<span class="${c}">${v}</span>`;const u=U[k];return`<span class="${c}">${v}${u?`<span class="unit" style="color:inherit;opacity:.7">${u}</span>`:''}</span>`};
const getNewProps=()=>{const used=new Set();SG.forEach(g=>g.specs?.forEach(s=>used.add(s)));return allProps.filter(p=>!used.has(p.name))};
const loadSG=async()=>{try{const r=await fetch(`${API}/config/${cur}`);const data=await r.json();if(data.specGroups&&data.specGroups.length>0){SG=data.specGroups;console.log('‚úÖ ÈÖçÁΩÆ‰ªéÊúçÂä°Âô®Âä†ËΩΩ')}else{SG=JSON.parse(JSON.stringify(defaultSG));console.log('üìã ‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ')}}catch(e){console.warn('‚ö†Ô∏è ÈÖçÁΩÆÂä†ËΩΩÂ§±Ë¥•');SG=JSON.parse(JSON.stringify(defaultSG))}};
const saveSG=async()=>{try{const r=await fetch(`${API}/config/${cur}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({specGroups:SG})});if(r.ok)console.log('‚úÖ ÈÖçÁΩÆÂ∑≤‰øùÂ≠òÂà∞ Notion')}catch(e){console.error('‚ùå ‰øùÂ≠òÂ§±Ë¥•:',e)}};
const fC=async()=>{const r=await fetch(`${API}/categories`);C=await r.json();if(C.length){cur=C[0].id;defaultSG=C[0].specGroups||[]}};
const fR=async c=>{document.getElementById('app').innerHTML=`<div class="loading"><div class="spinner"></div><span>Loading ${c} data...</span></div>`;try{const r=await fetch(`${API}/robots/${c}`);const data=await r.json();R=data.robots;allProps=data.properties;hasKSP=data.hasKSP||false;console.log('üîç ÂâçÁ´ØÊî∂Âà∞ hasKSP:',hasKSP);const cat=C.find(x=>x.id===c);defaultSG=cat?.specGroups||[];await loadSG();init();render()}catch(e){document.getElementById('app').innerHTML=`<div class="loading" style="color:#dc2626">Loading failed: ${e.message}<br><br><button onclick="location.reload()" style="padding:8px 16px;background:#3b82f6;color:#fff;border:none;border-radius:4px;cursor:pointer">Retry</button></div>`}};
const editGroup=(gid)=>{if(!isLoggedIn)return;const g=SG.find(x=>x.id===gid);if(!g)return;const modal=document.createElement('div');modal.className='edit-modal';modal.innerHTML=`<div class="edit-panel"><h2 style="font-size:18px;font-weight:600;margin-bottom:16px">Edit Group: ${g.name}</h2><label style="display:block;margin-bottom:12px"><span style="font-size:12px;color:#6b7280">Icon</span><input class="edit-input" id="edit-icon" value="${g.icon}"></label><label style="display:block;margin-bottom:12px"><span style="font-size:12px;color:#6b7280">Name</span><input class="edit-input" id="edit-name" value="${g.name}"></label><div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end"><button onclick="this.closest('.edit-modal').remove()" style="padding:8px 16px;background:#e5e7eb;border:none;border-radius:4px;cursor:pointer">Cancel</button><button onclick="saveGroup('${gid}')" style="padding:8px 16px;background:#3b82f6;color:#fff;border:none;border-radius:4px;cursor:pointer">Save</button></div></div>`;document.body.appendChild(modal)};
const saveGroup=async(gid)=>{const g=SG.find(x=>x.id===gid);g.icon=document.getElementById('edit-icon').value;g.name=document.getElementById('edit-name').value;await saveSG();document.querySelector('.edit-modal').remove();render()};
const deleteGroup=async(gid)=>{if(!isLoggedIn||!confirm('Delete this parameter group?'))return;SG=SG.filter(x=>x.id!==gid);await saveSG();render()};
const editSpec=(gid,idx)=>{if(!isLoggedIn)return;const g=SG.find(x=>x.id===gid);if(!g)return;const spec=g.specs[idx],better=g.better?.[idx]||'';const modal=document.createElement('div');modal.className='edit-modal';modal.innerHTML=`<div class="edit-panel"><h2 style="font-size:18px;font-weight:600;margin-bottom:16px">Edit Parameter</h2><div class="new-prop-hint">üí° ‰øÆÊîπÊ≠§ÈÖçÁΩÆÂè™ÂΩ±ÂìçÊòæÁ§∫Ôºå‰∏ç‰ºö‰øÆÊîπ Notion Êï∞ÊçÆÂ∫ì</div><label style="display:block;margin-bottom:12px"><span style="font-size:12px;color:#6b7280">Move to Group</span><select class="edit-input" id="edit-spec-group"><option value="${gid}">${g.icon} ${g.name} (ÂΩìÂâç)</option>${SG.filter(x=>x.id!==gid).map(x=>`<option value="${x.id}">${x.icon} ${x.name}</option>`).join('')}</select></label><label style="display:block;margin-bottom:12px"><span style="font-size:12px;color:#6b7280">Parameter Name</span><input class="edit-input" id="edit-spec-name" value="${spec}" readonly style="background:#f9fafb"></label><label style="display:block;margin-bottom:12px"><span style="font-size:12px;color:#6b7280">Better Value</span><select class="edit-input" id="edit-spec-better"><option value="" ${!better?'selected':''}>-</option><option value="max" ${better==='max'?'selected':''}>Higher is better</option><option value="min" ${better==='min'?'selected':''}>Lower is better</option></select></label><div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end"><button onclick="this.closest('.edit-modal').remove()" style="padding:8px 16px;background:#e5e7eb;border:none;border-radius:4px;cursor:pointer">Cancel</button><button onclick="saveSpec('${gid}',${idx})" style="padding:8px 16px;background:#3b82f6;color:#fff;border:none;border-radius:4px;cursor:pointer">Save</button></div></div>`;document.body.appendChild(modal)};
const saveSpec=async(gid,idx)=>{const oldG=SG.find(x=>x.id===gid);const newGid=document.getElementById('edit-spec-group').value;const newG=SG.find(x=>x.id===newGid);const spec=oldG.specs[idx];const better=document.getElementById('edit-spec-better').value;if(oldG.id===newG.id){if(!oldG.better)oldG.better=[];oldG.better[idx]=better}else{oldG.specs.splice(idx,1);if(oldG.better)oldG.better.splice(idx,1);if(!newG.specs)newG.specs=[];if(!newG.better)newG.better=[];newG.specs.push(spec);newG.better.push(better)}await saveSG();document.querySelector('.edit-modal').remove();render()};const deleteSpec=async(gid,idx)=>{if(!isLoggedIn||!confirm('Delete this parameter?'))return;const g=SG.find(x=>x.id===gid);g.specs.splice(idx,1);if(g.better)g.better.splice(idx,1);await saveSG();render()};
const showAddModal=()=>{if(!isLoggedIn){showLoginModal();return}const newProps=getNewProps();const modal=document.createElement('div');modal.className='edit-modal';modal.innerHTML=`<div class="edit-panel"><h2 style="font-size:18px;font-weight:600;margin-bottom:16px">Add New Item</h2>${newProps.length>0?`<div class="new-prop-hint">üí° Ê£ÄÊµãÂà∞ ${newProps.length} ‰∏™ Notion ‰∏≠ÁöÑÊñ∞Â±ûÊÄß</div>`:''}<div class="radio-group"><label class="radio-label"><input type="radio" name="add-type" value="group" checked onchange="toggleAddType()"> Parameter Group</label><label class="radio-label"><input type="radio" name="add-type" value="spec" onchange="toggleAddType()"> Parameter</label></div><div id="add-group-fields" style="margin-top:16px"><label style="display:block;margin-bottom:12px"><span style="font-size:12px;color:#6b7280">Group Icon</span><input class="edit-input" id="new-group-icon" placeholder="e.g., üîß"></label><label style="display:block;margin-bottom:12px"><span style="font-size:12px;color:#6b7280">Group Name</span><input class="edit-input" id="new-group-name" placeholder="e.g., Mechanical"></label></div><div id="add-spec-fields" style="margin-top:16px;display:none"><label style="display:block;margin-bottom:12px"><span style="font-size:12px;color:#6b7280">Add to Group</span><select class="edit-input" id="spec-group-select">${SG.map(g=>`<option value="${g.id}">${g.icon} ${g.name}</option>`).join('')}</select></label><label style="display:block;margin-bottom:12px"><span style="font-size:12px;color:#6b7280">Select Parameter</span><select class="edit-input" id="new-spec-select">${newProps.length>0?newProps.map(p=>`<option value="${p.name}">${p.name}</option>`).join(''):'<option disabled>All parameters added</option>'}</select></label><label style="display:block;margin-bottom:12px"><span style="font-size:12px;color:#6b7280">Better Value</span><select class="edit-input" id="new-spec-better"><option value="">-</option><option value="max">Higher is better</option><option value="min">Lower is better</option></select></label></div><div style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end"><button onclick="this.closest('.edit-modal').remove()" style="padding:8px 16px;background:#e5e7eb;border:none;border-radius:4px;cursor:pointer">Cancel</button><button onclick="saveNewItem()" style="padding:8px 16px;background:#3b82f6;color:#fff;border:none;border-radius:4px;cursor:pointer">Add</button></div></div>`;document.body.appendChild(modal)};
const toggleAddType=()=>{const type=document.querySelector('input[name="add-type"]:checked').value;document.getElementById('add-group-fields').style.display=type==='group'?'block':'none';document.getElementById('add-spec-fields').style.display=type==='spec'?'block':'none'};
const saveNewItem=async()=>{const type=document.querySelector('input[name="add-type"]:checked').value;if(type==='group'){const icon=document.getElementById('new-group-icon').value.trim();const name=document.getElementById('new-group-name').value.trim();if(!name){alert('Please enter a group name');return}SG.push({id:Date.now().toString(),icon:icon||'üìÅ',name,specs:[],better:[]})}else{const gid=document.getElementById('spec-group-select').value;const name=document.getElementById('new-spec-select').value;const better=document.getElementById('new-spec-better').value;if(!name){alert('Please select a parameter');return}const g=SG.find(x=>x.id===gid);if(!g)return;if(!g.specs)g.specs=[];if(!g.better)g.better=[];g.specs.push(name);g.better.push(better)}await saveSG();document.querySelector('.edit-modal').remove();render()};
const changeColNum=(delta)=>{numCols=Math.max(2,Math.min(10,numCols+delta));init();render()};
const startDragGroup=(gid,e)=>{if(!isLoggedIn)return;dragGroup=gid;e.stopPropagation()};
const startDragSpec=(gid,spec,idx,e)=>{if(!isLoggedIn)return;dragSpec={gid,spec,idx};e.stopPropagation()};
const allowDrop=(e)=>{if(!isLoggedIn)return;e.preventDefault()};
const dropGroup=(targetGid)=>{if(!isLoggedIn)return;event.preventDefault();if(!dragGroup||dragGroup===targetGid)return;const fromIdx=SG.findIndex(x=>x.id===dragGroup),toIdx=SG.findIndex(x=>x.id===targetGid);if(fromIdx<0||toIdx<0)return;const[item]=SG.splice(fromIdx,1);SG.splice(toIdx,0,item);saveSG();dragGroup=null;render()};
const dropSpec=(gid,idx)=>{if(!isLoggedIn)return;event.preventDefault();if(!dragSpec)return;const fromG=SG.find(x=>x.id===dragSpec.gid),toG=SG.find(x=>x.id===gid);if(!fromG||!toG)return;const spec=fromG.specs.splice(dragSpec.idx,1)[0];const better=fromG.better?fromG.better.splice(dragSpec.idx,1)[0]:'';toG.specs.splice(idx,0,spec);if(!toG.better)toG.better=[];toG.better.splice(idx,0,better);saveSG();dragSpec=null;render()};
window.editGroup=editGroup;window.saveGroup=saveGroup;window.deleteGroup=deleteGroup;window.editSpec=editSpec;window.saveSpec=saveSpec;window.deleteSpec=deleteSpec;window.showAddModal=showAddModal;window.toggleAddType=toggleAddType;window.saveNewItem=saveNewItem;window.changeColNum=changeColNum;window.startDragGroup=startDragGroup;window.startDragSpec=startDragSpec;window.allowDrop=allowDrop;window.dropGroup=dropGroup;window.dropSpec=dropSpec;window.showLoginModal=showLoginModal;window.doLogin=doLogin;window.doLogout=doLogout;
const render=()=>{document.documentElement.style.setProperty('--cols',numCols);const cat=C.find(c=>c.id===cur),B=gB(),sel=sM.map(id=>R.find(r=>r.id===id)||null);
document.getElementById('app').innerHTML=`
<div class="flex-shrink-0 bg-white shadow-sm" style="z-index:100">
<div class="px-4 py-2 border-b bg-gray-900 text-white flex items-center justify-between">
<h1 class="text-lg font-bold">Robot Comparison</h1>
<div class="flex items-center gap-4">
<div class="col-control">
<button class="col-btn" onclick="changeColNum(-1)" ${numCols<=2?'disabled':''}>‚àí</button>
<span class="col-count">${numCols} Cols</span>
<button class="col-btn" onclick="changeColNum(1)" ${numCols>=10?'disabled':''}>+</button>
</div>
${isLoggedIn?`<div class="user-info"><span>üë§ ${ADMIN_USER}</span><button class="logout-btn" onclick="doLogout()">Logout</button></div>`:'<span class="text-xs text-gray-400">Notion Real-time Sync</span>'}
</div>
</div>
<div class="grid-row"><div class="cell bg-gray-800"><select onchange="switchCat(this.value)" class="cat-select">${C.map(c=>`<option value="${c.id}" ${cur===c.id?'selected':''}>${c.icon} ${c.name}</option>`).join('')}</select></div>${sel.map((r,i)=>`<div class="img-cell flex items-center justify-center" style="${i<numCols-1?'border-right:2px solid #fff':''}">${r?.image?`<img src="${r.image}" onerror="this.outerHTML='<span class=\\'text-6xl\\'>${cat?.icon||'ü§ñ'}</span>'">`:`<span class="text-6xl">${cat?.icon||'ü§ñ'}</span>`}</div>`).join('')}</div>
<div class="grid-row"><div class="cell cell-label">Brand</div>${sel.map((_,i)=>`<div class="cell bg-gray-50"><select onchange="setBrand(${i},this.value)" class="simple-select brand-select">${B.map(b=>`<option value="${b}" ${sB[i]===b?'selected':''}>${b}</option>`).join('')}</select></div>`).join('')}</div>
<div class="grid-row border-b-2 border-gray-300"><div class="cell cell-label">Model</div>${sel.map((_,i)=>{const f=gM(sB[i]);return`<div class="cell bg-white"><select onchange="setModel(${i},this.value)" class="simple-select">${f.map(m=>`<option value="${m.id}" ${sM[i]===m.id?'selected':''}>${m.model}</option>`).join('')}</select></div>`}).join('')}</div>
</div>
<div class="scroll-area">
${hasKSP?`<div class="grid-row"><div class="cell cell-ksp-section" onclick="toggleKsp()"><span>‚≠ê KSP</span><span class="collapse-icon ${kspCol?'collapsed':''}">‚ñº</span></div>${sel.map(()=>`<div class="cell cell-ksp-section-empty"></div>`).join('')}</div>
${!kspCol?[0,1,2,3,4].map(x=>`<div class="grid-row"><div class="cell cell-ksp-label">KSP-${x+1}</div>${sel.map(r=>`<div class="cell cell-ksp">${r?.ksp?.[x]||'‚Äì'}</div>`).join('')}</div>`).join(''):''}`:``}
${SG.map(g=>`<div class="grid-row" ${isLoggedIn?`draggable="true" ondragstart="startDragGroup('${g.id}',event)" ondragover="allowDrop(event)" ondrop="dropGroup('${g.id}')"`:''}><div class="cell cell-section" onclick="toggleG('${g.id}')"><span>${g.icon} ${g.name}</span><span class="collapse-icon ${col[g.id]?'collapsed':''}">‚ñº</span>${isLoggedIn?`<button class="action-btn edit" onclick="event.stopPropagation();editGroup('${g.id}')">Edit</button><button class="action-btn delete" onclick="event.stopPropagation();deleteGroup('${g.id}')">Del</button><span class="drag-handle">‚ãÆ‚ãÆ</span>`:''}</div>${sel.map(()=>`<div class="cell cell-section-empty"></div>`).join('')}</div>${!col[g.id]?g.specs.map((k,i)=>{const b=g.better?.[i]||'',{best,worst}=bw(sel,k,b),isS=b!=='',isSw=swap[k];return`<div class="grid-row" ${isLoggedIn?`draggable="true" ondragstart="startDragSpec('${g.id}','${k}',${i},event)" ondragover="allowDrop(event)" ondrop="dropSpec('${g.id}',${i})"`:''}}><div class="cell cell-label ${isS?'cell-label-click':''}" ${isS?`onclick="toggleSwap('${k}')"`:''} >${k}${isS&&isSw?'<span style="font-size:9px;color:#9ca3af;margin-left:4px">‚áÖ</span>':''}${isLoggedIn?`<button class="action-btn edit" onclick="event.stopPropagation();editSpec('${g.id}',${i})">Edit</button><button class="action-btn delete" onclick="event.stopPropagation();deleteSpec('${g.id}',${i})">Del</button><span class="drag-handle">‚ãÆ‚ãÆ</span>`:''}</div>${sel.map(r=>{const v=r?.specs[k];if(!r)return`<div class="cell" style="background:#f9fafb;color:#d1d5db">‚Äì</div>`;if(v===best)return`<div class="cell">${ft(k,v,'tag-best')}</div>`;if(v===worst)return`<div class="cell">${ft(k,v,'tag-worst')}</div>`;return`<div class="cell">${fv(k,v)}</div>`}).join('')}</div>`}).join(''):''}`.replace(/\n\s*/g,'')).join('')}
<div class="grid-row add-row"><div class="cell add-btn ${isLoggedIn?'':'locked'}" onclick="showAddModal()">${isLoggedIn?'+':lockSvg}</div>${sel.map(()=>`<div class="cell" style="background:transparent;border:none;min-height:40px"></div>`).join('')}</div>
<div class="footer">¬© 2026 Proper Design Consultancy</div>
</div>
`};
const toggleG=id=>{col[id]=!col[id];render()};const toggleKsp=()=>{kspCol=!kspCol;render()};const toggleSwap=k=>{swap[k]=!swap[k];render()};
const switchCat=c=>{cur=c;fR(c)};const setBrand=(i,b)=>{sB[i]=b;const m=gM(b);sM[i]=m[0]?.id||null;render()};const setModel=(i,id)=>{sM[i]=id;render()};
checkAuth();
(async()=>{await fC();if(cur)await fR(cur)})();
</script>
</body>
</html>
